<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pagamento — Uener Linguço</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="shortcut icon" href="img/logo.png" type="image/x-icon">
  <!-- Redesign Completo 2025 -->
  <style>
    /* Estilos específicos da página de pagamento */
    body {
      background: linear-gradient(135deg, #bb3e03 0%, #f5e7d3 100%);
      min-height: 100vh;
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      color: #232526;
    }

    .header {
      background: #bb3e03;
      color: #fff;
      padding: 24px 0 12px 0;
      text-align: center;
      border-bottom: 4px solid #fff;
      margin-bottom: 32px;
    }

    .header img {
      height: 50px;
      margin-bottom: 8px;
    }

    .header h1 {
      font-size: 2rem;
      margin: 0;
      letter-spacing: 1px;
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: 0 16px 32px 16px;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(187, 62, 3, 0.2);
      padding: 32px;
    }

    .card h2 {
      color: #bb3e03;
      margin-top: 0;
      border-bottom: 2px solid #bb3e03;
      padding-bottom: 12px;
    }

    .total-banner {
      background: #f5e7d3;
      border: 2px solid #bb3e03;
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      font-size: 1.4rem;
      font-weight: bold;
      color: #bb3e03;
      margin-bottom: 24px;
    }

    .pedido-itens {
      background: #f9f5f0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
      max-height: 200px;
      overflow-y: auto;
    }

    .pedido-item {
      padding: 8px 0;
      border-bottom: 1px solid #ddd;
      font-size: 0.95rem;
      color: #232526;
    }

    .pedido-item:last-child {
      border-bottom: none;
    }

    .formas-wrap {
      margin-bottom: 24px;
    }

    .formas-wrap h3 {
      color: #bb3e03;
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 1.1rem;
    }

    .formas-fieldset {
      border: none;
      padding: 0;
      margin: 0;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .radio-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-weight: 500;
      user-select: none;
    }

    .radio-label input[type="radio"] {
      cursor: pointer;
      width: 20px;
      height: 20px;
      accent-color: #bb3e03;
    }

    /* Container PIX */
    #pix-container {
      display: none;
      background: #f0f8ff;
      border: 2px solid #0066cc;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
      text-align: center;
    }

    #pix-container.visible {
      display: block;
    }

    #pix-container h4 {
      color: #0066cc;
      margin-top: 0;
    }

    .qr-placeholder {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      display: inline-block;
      margin-bottom: 12px;
    }

    .qr-placeholder img {
      width: 200px;
      height: 200px;
      display: block;
    }

    .pix-help {
      font-size: 0.9rem;
      color: #666;
      margin: 8px 0;
    }

    .pix-payload {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.85rem;
      background: #f9f9f9;
      box-sizing: border-box;
      margin-bottom: 12px;
      resize: vertical;
    }

    .copy-btn {
      background: #0066cc;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }

    .copy-btn:hover {
      background: #0052a3;
    }

    .copy-btn:active {
      transform: scale(0.98);
    }

    /* Container Cartão */
    #cartao-container {
      display: none;
      background: #fff5f0;
      border: 2px solid #bb3e03;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
    }

    #cartao-container.visible {
      display: block;
    }

    #cartao-container h4 {
      color: #bb3e03;
      margin-top: 0;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-weight: bold;
      color: #232526;
      margin-bottom: 6px;
      font-size: 0.95rem;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      box-sizing: border-box;
      font-family: monospace;
    }

    .form-group input:focus {
      outline: none;
      border-color: #bb3e03;
      box-shadow: 0 0 4px rgba(187, 62, 3, 0.3);
    }

    .form-row {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 12px;
    }

    /* Botões de ação */
    .actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
    }

    .btn {
      flex: 1;
      min-width: 140px;
      padding: 14px 20px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .btn-primary {
      background: #bb3e03;
      color: #fff;
    }

    .btn-primary:hover:not(:disabled) {
      background: #a03502;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(187, 62, 3, 0.3);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: transparent;
      color: #bb3e03;
      border: 2px solid #bb3e03;
    }

    .btn-secondary:hover {
      background: #bb3e03;
      color: #fff;
    }

    /* Status e mensagens */
    .status-msg {
      display: none;
      padding: 14px;
      border-radius: 6px;
      margin-bottom: 16px;
      text-align: center;
      font-weight: bold;
    }

    .status-msg.erro {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #c62828;
      display: block;
    }

    .status-msg.sucesso {
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #2e7d32;
      display: block;
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #bb3e03;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Sucesso final */
    #sucesso-msg {
      display: none;
      background: #e8f5e9;
      border: 2px solid #2e7d32;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      color: #2e7d32;
      margin-bottom: 20px;
    }

    #sucesso-msg p {
      margin: 0 0 12px 0;
      font-size: 1.1rem;
      font-weight: bold;
    }

    @media (max-width: 600px) {
      .card {
        padding: 20px;
      }

      .formas-fieldset {
        flex-direction: column;
        gap: 12px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .actions {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <img src="img/logo.png" alt="Logo Uener Linguço">
    <h1>Pagamento</h1>
  </header>

  <!-- Main -->
  <main class="container">
    <div class="card">
      <!-- Status inicial -->
      <div id="status-msg" class="status-msg"></div>

      <!-- Sucesso -->
      <div id="sucesso-msg">
        <p>✓ Pagamento realizado com sucesso!</p>
        <p>Você será redirecionado em breve...</p>
      </div>

      <!-- Conteúdo principal -->
      <div id="conteudo-principal">
        <!-- Total -->
        <div class="total-banner">
          Total: R$ <span id="total-valor">0,00</span>
        </div>

        <!-- Itens do pedido -->
        <div class="pedido-itens" id="pedido-itens">
          <p style="text-align: center; color: #999;">Carregando itens...</p>
        </div>

        <!-- Formas de pagamento -->
        <div class="formas-wrap">
          <h3>Forma de Pagamento</h3>
          <div id="formas-list" class="formas-fieldset">
            <p style="text-align: center; color: #999;">Carregando formas...</p>
          </div>
        </div>

        <!-- Container PIX -->
        <div id="pix-container">
          <h4>Pagamento via PIX</h4>
          <p class="pix-help">Escaneie o QR Code com seu app bancário ou copie o código</p>
          <div class="qr-placeholder">
            <img id="qr-img" src="" alt="QR Code PIX">
          </div>
          <p class="pix-help">Copia e cola:</p>
          <textarea id="pix-payload" class="pix-payload" rows="3" readonly></textarea>
          <button id="copy-btn" class="copy-btn">Copiar código PIX</button>
        </div>

        <!-- Container Cartão -->
        <div id="cartao-container">
          <h4>Pagamento com Cartão de Crédito</h4>
          <form id="form-cartao" onsubmit="return false;">
            <div class="form-group">
              <label for="numero-cartao">Número do Cartão</label>
              <input type="text" id="numero-cartao" placeholder="0000 0000 0000 0000" maxlength="19" autocomplete="off">
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="validade">Validade (MM/AA)</label>
                <input type="text" id="validade" placeholder="MM/AA" maxlength="5" autocomplete="off">
              </div>
              <div class="form-group">
                <label for="cvv">CVV</label>
                <input type="text" id="cvv" placeholder="123" maxlength="4" autocomplete="off">
              </div>
            </div>
          </form>
        </div>

        <!-- Botões de ação -->
        <div class="actions">
          <button id="concluir" class="btn btn-primary">Concluir Pagamento</button>
          <button id="voltar" class="btn btn-secondary">← Voltar</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Scripts -->
  <script src="js/script.js"></script>
  <script src="js/app-avap2.js"></script>
  <script>
    /**
     * ===== PÁGINA DE PAGAMENTO =====
     * Integração com API avap2 para pagamentos via PIX e cartão
     * - Carrega pedido e itens da API
     * - Gera payload PIX EMV válido com CRC16
     * - Suporta múltiplas formas de pagamento
     * - Integrado com sessionStorage para idPedidoAtual
     */

    'use strict';

    // ===== ELEMENTOS DO DOM =====
    const els = {
      totalValor: document.getElementById('total-valor'),
      pedidoItens: document.getElementById('pedido-itens'),
      formasList: document.getElementById('formas-list'),
      pixContainer: document.getElementById('pix-container'),
      cartaoContainer: document.getElementById('cartao-container'),
      qrImg: document.getElementById('qr-img'),
      pixPayload: document.getElementById('pix-payload'),
      copyBtn: document.getElementById('copy-btn'),
      concluirBtn: document.getElementById('concluir'),
      voltarBtn: document.getElementById('voltar'),
      statusMsg: document.getElementById('status-msg'),
      sucessoMsg: document.getElementById('sucesso-msg'),
      conteudoPrincipal: document.getElementById('conteudo-principal'),
      formCartao: document.getElementById('form-cartao')
    };

    // ===== ESTADO GLOBAL =====
    let totalPedido = 0;
    let pedidoAtual = null;

    // ===== FUNÇÕES UTILITÁRIAS =====
    function log(...args) {
      console.log('[pagamento]', ...args);
    }

    function logError(msg) {
      console.error('[pagamento] ❌', msg);
    }

    function showError(msg) {
      showStatus(msg, 'erro');
    }

    function showStatus(msg, tipo) {
      els.statusMsg.textContent = msg;
      els.statusMsg.className = `status-msg ${tipo}`;
      if (tipo === 'sucesso') {
        setTimeout(() => { els.statusMsg.className = 'status-msg'; }, 3000);
      }
    }

    // ===== INICIALIZAÇÃO =====
    async function init() {
      log('init iniciando...');
      try {
        // 0. Carregar configuração PIX do backend
        await carregarConfigPixBackend();

        // 1. Validar sessão
        const user = await verificarSessao();
        if (!user) {
          showStatus('Você precisa fazer login para acessar o pagamento', 'erro');
          setTimeout(() => { window.location.href = '/login.html'; }, 1500);
          return;
        }
        log('Usuário autenticado:', user.nomepessoa);

        // 2. Validar pedido em sessionStorage
        const pedidoId = sessionStorage.getItem('idPedidoAtual');
        if (!pedidoId) {
          showStatus('Pedido não encontrado. Por favor, confirme um pedido antes de pagar.', 'erro');
          setTimeout(() => { window.location.href = '/index.html'; }, 2000);
          return;
        }
        log('Pedido ID recuperado:', pedidoId);

        // 3. Carregar pedido e formas
        await carregarPedido(pedidoId);
        await carregarFormas();

        // 4. Configurar listeners
        configurarListeners();

        log('Página carregada com sucesso');
      } catch (err) {
        log('Erro na inicialização:', err.message);
        showStatus(`Erro ao carregar página: ${err.message}`, 'erro');
      }
    }

    // ===== CARREGAR PEDIDO =====
    async function carregarPedido(id) {
      try {
        log('Carregando pedido ID:', id);
        const resp = await fetch(`/api/pedidos/${encodeURIComponent(id)}`, { credentials: 'include' });

        if (!resp.ok) {
          throw new Error(`Erro HTTP ${resp.status}`);
        }

        const json = await resp.json();
        log('Resposta da API:', json);

        if (!json.success) {
          throw new Error(json.message || 'Resposta inválida');
        }

        pedidoAtual = json.data;
        const itens = pedidoAtual.itens || [];
        log('Itens do pedido:', itens);

        renderizarItens(itens);
      } catch (err) {
        log('Erro ao carregar pedido:', err.message);
        throw new Error(`Erro ao carregar pedido: ${err.message}`);
      }
    }

    // ===== RENDERIZAR ITENS =====
    function renderizarItens(itens) {
      totalPedido = 0;
      els.pedidoItens.innerHTML = '';

      if (!Array.isArray(itens) || itens.length === 0) {
        els.pedidoItens.innerHTML = '<p style="text-align: center; color: #999;">Nenhum item no pedido</p>';
        return;
      }

      itens.forEach(item => {
        const nome = item.nomeproduto || item.nome || 'Item';
        const preco = parseFloat(item.precounitario || item.preco || 0) || 0;
        const qtd = parseInt(item.quantidade || 1, 10) || 1;
        const subtotal = preco * qtd;

        totalPedido += subtotal;

        const div = document.createElement('div');
        div.className = 'pedido-item';
        div.textContent = `${qtd} × ${nome} — R$ ${preco.toFixed(2)}`;
        els.pedidoItens.appendChild(div);
      });

      // Exibir total formatado
      els.totalValor.textContent = totalPedido.toFixed(2).replace('.', ',');
      els.totalValor.dataset.total = totalPedido.toFixed(2);

      log('Total calculado:', totalPedido);

      // Gerar PIX se total > 0
      if (totalPedido > 0) {
        gerarPix(totalPedido);
      }
    }

    // ===== CARREGAR FORMAS DE PAGAMENTO =====
    async function carregarFormas() {
      try {
        log('Carregando formas de pagamento...');
        const resp = await fetch('/api/formas-pagamento', { credentials: 'include' });

        if (!resp.ok) {
          throw new Error(`Erro HTTP ${resp.status}`);
        }

        const json = await resp.json();
        log('Formas carregadas:', json);

        if (!json.success) {
          throw new Error(json.message || 'Resposta inválida');
        }

        const formas = json.data || json.formas || [];
        renderizarFormas(formas);
      } catch (err) {
        log('Erro ao carregar formas:', err.message);
        // Fallback: mostrar PIX como opção padrão
        renderizarFormas([{ idformapagamento: 1, nomeformapagamento: 'PIX' }]);
      }
    }

    // ===== RENDERIZAR FORMAS DE PAGAMENTO =====
    function renderizarFormas(formas) {
      els.formasList.innerHTML = '';

      const defaultFormas = [
        { idformapagamento: 1, nomeformapagamento: 'PIX' },
        { idformapagamento: 2, nomeformapagamento: 'Cartão de Crédito' },
        { idformapagamento: 3, nomeformapagamento: 'Cartão de Débito' }
      ];

      // Se nenhuma forma foi retornada, usar defaults
      const formasUsar = formas && formas.length > 0 ? formas : defaultFormas;

      formasUsar.forEach((forma, idx) => {
        const id = forma.idformapagamento || forma.id || forma.forma_pagamento_id || idx + 1;
        const nome = forma.nomeformapagamento || forma.name || forma.nome || `Forma ${id}`;

        const label = document.createElement('label');
        label.className = 'radio-label';

        const input = document.createElement('input');
        input.type = 'radio';
        input.name = 'forma-pagamento';
        input.value = id;
        if (idx === 0) input.checked = true;

        input.addEventListener('change', atualizarContainerPagamento);

        label.appendChild(input);
        label.appendChild(document.createTextNode(' ' + nome));

        els.formasList.appendChild(label);
      });

      // Exibir PIX por padrão
      atualizarContainerPagamento();
    }

    // ===== ATUALIZAR CONTAINER BASEADO NA FORMA SELECIONADA =====
    function atualizarContainerPagamento() {
      const formaSelect = document.querySelector('input[name="forma-pagamento"]:checked');
      if (!formaSelect) return;

      const formaId = formaSelect.value;
      const formaText = formaSelect.nextSibling.textContent.trim().toLowerCase();

      log('Forma selecionada:', formaId, formaText);

      // PIX: mostrar QR e payload
      if (formaText.includes('pix') || formaId === 'pix' || formaId === '1') {
        els.pixContainer.classList.add('visible');
        els.cartaoContainer.classList.remove('visible');
      }
      // Cartão: mostrar formulário
      else if (formaText.includes('cartão') || formaText.includes('crédito') || formaText.includes('débito')) {
        els.pixContainer.classList.remove('visible');
        els.cartaoContainer.classList.add('visible');
      }
      // Padrão: PIX
      else {
        els.pixContainer.classList.add('visible');
        els.cartaoContainer.classList.remove('visible');
      }
    }

    // ===== PIX: CRC16 XModem (CCITT) =====
    function crc16xmodem(str) {
      let crc = 0x0000;
      for (let i = 0; i < str.length; i++) {
        crc ^= (str.charCodeAt(i) << 8);
        for (let j = 0; j < 8; j++) {
          crc = (crc & 0x8000) ? ((crc << 1) ^ 0x1021) : (crc << 1);
          crc = crc & 0xFFFF;
        }
      }
      return crc & 0xFFFF;
    }

    // ===== PIX: TAG HELPER =====
    function tag(id, value) {
      const v = String(value || '');
      const len = String(v.length).padStart(2, '0');
      return `${id}${len}${v}`;
    }

    // ===== PIX: CONSTRUIR PAYLOAD EMV VÁLIDO (SPEC BANCO CENTRAL) =====
    let pixConfig = {
      pixKey: 'uperesmarcon@gmail.com',
      merchantName: 'UENER LINGUÇO',
      merchantCity: 'CAMPO MOURAO'
    };

    // Carregar configuração PIX do backend
    async function carregarConfigPixBackend() {
      try {
        const resp = await fetch('/api/pix-config');
        const json = await resp.json();
        if (json.success && json.config) {
          pixConfig = json.config;
          log('✓ Configuração PIX carregada do backend:', pixConfig.pixKey);
        }
      } catch (err) {
        log('Usando configuração PIX padrão');
      }
    }

    // ===== UTILITÁRIO: REMOVER DIACRÍTICOS =====
    function removerDiacriticos(str) {
      return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    function construirPayloadPix(valor) {
      // Construir payload conforme ESPECIFICAÇÃO OFICIAL DO BANCO CENTRAL DO BRASIL
      // Ref: https://www.bcb.gov.br/estabilidadefinanceira/pix
      
      let payload = '';
      
      // 00: Formato de Payload (sempre 01)
      payload += tag('00', '01');
      
      // 26: Merchant Account Information (PIX)
      // Estrutura interna: 00=GUID, 01=chave PIX
      let mai = tag('00', 'BR.GOV.BCB.PIX'); // ✅ MAIÚSCULO
      const chaveValida = pixConfig.pixKey || 'uperesmarcon@gmail.com';
      mai += tag('01', chaveValida);
      payload += tag('26', mai);
      
      // 52: Merchant Category Code (MCC)
      // 0000 = sem categoria
      payload += tag('52', '0000');
      
      // 53: Código da moeda (986 = BRL, obrigatório)
      payload += tag('53', '986');
      
      // 54: Valor da transação (OPCIONAL se PIX cópia-cola)
      // Incluir apenas se tiver valor fixo
      if (valor && valor > 0) {
        payload += tag('54', Number(valor).toFixed(2));
      }
      
      // 58: Código do país (BR, obrigatório)
      payload += tag('58', 'BR');
      
      // 59: Nome do merchant (até 25 chars, sem acentos idealmente)
      // ✅ Remove diacríticos (ç→c, ã→a, etc)
      const merchantNameRaw = pixConfig.merchantName || 'UENER LINGUÇO';
      const merchantName = removerDiacriticos(merchantNameRaw).toUpperCase().slice(0, 25);
      payload += tag('59', merchantName);
      
      // 60: Cidade do merchant (até 15 chars, sem acentos)
      // ✅ Remove diacríticos
      const merchantCityRaw = pixConfig.merchantCity || 'CAMPO MOURAO';
      const merchantCity = removerDiacriticos(merchantCityRaw).toUpperCase().slice(0, 15);
      payload += tag('60', merchantCity);
      
      // 62: Campo Adicional (Additional Data Field)
      // 05 = Transaction ID (Identificador único)
      const txid = 'UENER' + Date.now();
      const adf = tag('05', txid.slice(0, 25)); // máx 25 chars
      payload += tag('62', adf);
      
      // 63: Checksum (CRC16-CCITT / XModem)
      // Obrigatório, sempre os últimos 4 dígitos
      const payloadForCrc = payload + '6304';
      const crc = crc16xmodem(payloadForCrc).toString(16).toUpperCase().padStart(4, '0');
      payload += '6304' + crc;
      
      return payload;
    }

    // ===== PIX: GERAR QR CODE (BACKEND) =====
    async function gerarPix(valor) {
      log('Gerando PIX para valor: R$', valor.toFixed(2));

      try {
        log('Chamando backend: /api/pix/generate');
        
        // ✅ Chamar backend para gerar PIX
        const resp = await fetch(`/api/pix/generate?amount=${valor.toFixed(2)}`);
        
        if (!resp.ok) {
          throw new Error(`Erro HTTP ${resp.status}`);
        }

        const data = await resp.json();
        
        if (!data.payload) {
          throw new Error('Payload não retornado pelo backend');
        }

        const payload = data.payload;
        
        log('✓ Payload recebido do backend');
        log('Comprimento:', payload.length, 'caracteres');
        log('CRC:', data.crc);
        log('Validado:', data.validado ? 'SIM' : 'NÃO');
        log('Primeiros 50 chars:', payload.slice(0, 50) + '...');
        log('Últimos 10 chars (CRC):', payload.slice(-10));

        // Armazenar no textarea
        els.pixPayload.value = payload;
        els.pixPayload.style.minHeight = '80px';
        els.pixPayload.style.wordWrap = 'break-word';

        // Validar payload: deve terminar com 6304XXXX
        if (!payload.match(/6304[0-9A-Fa-f]{4}$/)) {
          logError('⚠️  Aviso: payload pode não estar válido');
          showError('Erro ao gerar PIX: CRC inválido');
          return;
        }
        log('✓ Validação de CRC passou');

        // Usar QR do backend ou gerar localmente
        const qrUrl = data.qr || `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(payload)}`;
        log('QR Code URL:', qrUrl.substring(0, 50) + '...');
        
        els.qrImg.src = qrUrl;
        els.qrImg.style.display = 'block';
        
        log('✓ QR Code exibido');
      } catch (err) {
        logError(`Erro ao gerar PIX: ${err.message}`);
        showError(`Erro ao gerar PIX: ${err.message}`);
      }
    }

    // ===== COPY TO CLIPBOARD (MODERNO) =====
    function copiarPixPayload() {
      const payload = els.pixPayload.value;
      if (!payload) {
        showStatus('Nenhum código PIX para copiar', 'erro');
        return;
      }

      // Tentar usar Clipboard API (moderno)
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(payload)
          .then(() => {
            showStatus('✓ Código PIX copiado para a área de transferência!', 'sucesso');
            log('Código PIX copiado via Clipboard API');
          })
          .catch(err => {
            log('Clipboard API falhou, tentando fallback...');
            copiarPixPayloadFallback(payload);
          });
      } else {
        // Fallback para execCommand
        copiarPixPayloadFallback(payload);
      }
    }

    function copiarPixPayloadFallback(payload) {
      try {
        els.pixPayload.select();
        els.pixPayload.setSelectionRange(0, 99999); // Mobile
        document.execCommand('copy');
        showStatus('✓ Código PIX copiado! (modo compatibilidade)', 'sucesso');
        log('Código PIX copiado via execCommand');
      } catch (err) {
        showStatus('❌ Erro ao copiar código PIX', 'erro');
        log('Erro ao copiar:', err.message);
      }
    }

    // ===== VALIDAÇÕES CARTÃO =====
    function validarNumeroCartao(num) {
      // Algoritmo de Luhn
      let arr = num.split('').reverse().map(x => parseInt(x));
      let sum = arr.reduce((acc, val, idx) => {
        if (idx % 2) {
          val *= 2;
          if (val > 9) val -= 9;
        }
        return acc + val;
      }, 0);
      return sum % 10 === 0;
    }

    function validarValidade(valor) {
      const [mes, ano] = valor.split('/').map(Number);
      if (!mes || !ano || mes < 1 || mes > 12) return false;
      const agora = new Date();
      const anoAtual = agora.getFullYear() % 100;
      const mesAtual = agora.getMonth() + 1;
      return ano > anoAtual || (ano === anoAtual && mes >= mesAtual);
    }

    function validarCvv(cvv) {
      return /^\d{3,4}$/.test(cvv);
    }

    // ===== CONCLUIR PAGAMENTO =====
    async function concluirPagamento() {
      try {
        log('Concluindo pagamento...');

        // Validar pedido
        const pedidoId = sessionStorage.getItem('idPedidoAtual');
        if (!pedidoId) {
          throw new Error('Pedido não encontrado');
        }

        // Validar forma selecionada
        const formaSelect = document.querySelector('input[name="forma-pagamento"]:checked');
        if (!formaSelect) {
          throw new Error('Selecione uma forma de pagamento');
        }

        const formaId = formaSelect.value;
        const formaText = formaSelect.nextSibling.textContent.trim().toLowerCase();

        // Validar cartão se selecionado
        if (formaText.includes('cartão') || formaText.includes('crédito') || formaText.includes('débito')) {
          const numCartao = document.getElementById('numero-cartao').value.replace(/\s/g, '');
          const validade = document.getElementById('validade').value;
          const cvv = document.getElementById('cvv').value;

          if (!numCartao || numCartao.length < 13) {
            throw new Error('Número de cartão inválido');
          }
          if (!validarNumeroCartao(numCartao)) {
            throw new Error('Número de cartão inválido (falha na validação)');
          }
          if (!validarValidade(validade)) {
            throw new Error('Data de validade inválida ou expirada');
          }
          if (!validarCvv(cvv)) {
            throw new Error('CVV inválido');
          }
        }

        // Preparar payload de pagamento
        const payload = {
          idpedido: pedidoId,
          idformadepagamento: formaId,
          valorpagamento: totalPedido,
          pedidoId: pedidoId,
          formaPagamentoId: formaId,
          valor: totalPedido
        };

        log('Enviando pagamento:', payload);

        // Desabilitar botão e mostrar spinner
        els.concluirBtn.disabled = true;
        els.concluirBtn.textContent = 'Processando... ';
        const spinner = document.createElement('span');
        spinner.className = 'spinner';
        els.concluirBtn.appendChild(spinner);

        // Enviar para API
        const resp = await fetch('/api/pagamentos', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const json = await resp.json();
        log('Resposta pagamento:', resp.status, json);

        if (!resp.ok || !json.success) {
          throw new Error(json.message || `Erro HTTP ${resp.status}`);
        }

        // SUCESSO
        log('Pagamento criado com sucesso!');
        els.conteudoPrincipal.style.display = 'none';
        els.sucessoMsg.style.display = 'block';

        // Limpar sessão
        sessionStorage.removeItem('idPedidoAtual');
        localStorage.removeItem('carrinho');

        // Redirecionar após 2 segundos
        setTimeout(() => {
          window.location.href = '/confirmacao.html';
        }, 2000);
      } catch (err) {
        log('Erro ao concluir:', err.message);
        showStatus(`Erro: ${err.message}`, 'erro');
        els.concluirBtn.disabled = false;
        els.concluirBtn.innerHTML = 'Concluir Pagamento';
      }
    }

    // ===== CONFIGURAR LISTENERS =====
    function configurarListeners() {
      els.copyBtn.addEventListener('click', copiarPixPayload);
      els.concluirBtn.addEventListener('click', concluirPagamento);
      els.voltarBtn.addEventListener('click', () => {
        window.location.href = '/index.html';
      });

      // Formatação de cartão
      document.getElementById('numero-cartao').addEventListener('input', (e) => {
        let v = e.target.value.replace(/\D/g, '').slice(0, 16);
        v = v.match(/.{1,4}/g)?.join(' ') || v;
        e.target.value = v;
      });

      // Formatação de validade
      document.getElementById('validade').addEventListener('input', (e) => {
        let v = e.target.value.replace(/\D/g, '').slice(0, 4);
        if (v.length > 2) v = v.slice(0, 2) + '/' + v.slice(2);
        e.target.value = v;
      });

      // Apenas números em CVV
      document.getElementById('cvv').addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/\D/g, '').slice(0, 4);
      });
    }

    // ===== INICIAR QUANDO DOM ESTIVER PRONTO =====
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
